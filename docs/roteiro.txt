
(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>git status
On branch main
Your branch is up to date with 'origin/main'.

nothing to commit, working tree clean

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm login
npm notice Log in on https://registry.npmjs.org/
npm notice SECURITY NOTICE: Classic tokens expire December 9. Granular tokens now limited to 90 days with 2FA enforced by default. Update your CI/CD workflows to avoid disruption. Learn more: https://gh.io/npm-token-changes
Login at:
https://www.npmjs.com/login?next=/login/cli/6e83e42f-5109-4336-8338-60fd85a69569
Press ENTER to open in the browser...
Username: joao.ssa
npm ERR! canceled

npm ERR! A complete log of this run can be found in: C:\Users\joaos\AppData\Local\npm-cache\_logs\2025-12-04T00_06_41_753Z-debug-0.log

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm login
npm notice Log in on https://registry.npmjs.org/
npm notice SECURITY NOTICE: Classic tokens expire December 9. Granular tokens now limited to 90 days with 2FA enforced by default. Update your CI/CD workflows to avoid disruption. Learn more: https://gh.io/npm-token-changes
Login at:
https://www.npmjs.com/login?next=/login/cli/45525d55-fcd3-4855-b889-35e9ea1e92ad
Press ENTER to open in the browser...

Logged in on https://registry.npmjs.org/.

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm whoami
joao.ssa

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm install @prisma/cli --save-dev
npm WARN deprecated @prisma/cli@2.20.1: Prisma CLI package was renamed to 'prisma'. Check it out here: https://www.npmjs.com/package/prisma
npm ERR! code 1
npm ERR! path F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025\node_modules\@prisma\cli
npm ERR! command failed
npm ERR! command C:\WINDOWS\system32\cmd.exe /d /s /c node scripts/preinstall-entry.js
npm ERR! ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
npm ERR! ‚îÇ                                                                             ‚îÇ
npm ERR! ‚îÇ     The package @prisma/cli has been renamed to prisma.                     ‚îÇ
npm ERR! ‚îÇ                                                                             ‚îÇ
npm ERR! ‚îÇ     Please uninstall @prisma/cli first.                                     ‚îÇ
npm ERR! ‚îÇ     Then install prisma to continue using Prisma CLI:                       ‚îÇ
npm ERR! ‚îÇ                                                                             ‚îÇ
npm ERR! ‚îÇ         # Uninstall old CLI                                                 ‚îÇ
npm ERR! ‚îÇ         npm uninstall @prisma/cli                                           ‚îÇ
npm ERR! ‚îÇ                                                                             ‚îÇ
npm ERR! ‚îÇ         # Install new CLI                                                   ‚îÇ
npm ERR! ‚îÇ         npm install prisma --save-dev                                       ‚îÇ
npm ERR! ‚îÇ                                                                             ‚îÇ
npm ERR! ‚îÇ         # Invoke via npx                                                    ‚îÇ
npm ERR! ‚îÇ         npx prisma --help                                                   ‚îÇ
npm ERR! ‚îÇ                                                                             ‚îÇ
npm ERR! ‚îÇ     Learn more here: https://github.com/prisma/prisma/releases/tag/2.16.0   ‚îÇ
npm ERR! ‚îÇ                                                                             ‚îÇ
npm ERR! ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

npm ERR! A complete log of this run can be found in: C:\Users\joaos\AppData\Local\npm-cache\_logs\2025-12-04T00_32_06_368Z-debug-0.log

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm uninstall @prisma/cli

up to date in 522ms

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm install prisma --save-dev
npm WARN EBADENGINE Unsupported engine {
npm WARN EBADENGINE   package: 'prisma@7.1.0',
npm WARN EBADENGINE   required: { node: '^20.19 || ^22.12 || >=24.0' },
npm WARN EBADENGINE   current: { node: 'v20.12.2', npm: '10.5.0' }
npm WARN EBADENGINE }
npm WARN cleanup Failed to remove some directories [
npm WARN cleanup   [
npm WARN cleanup     'F:\\DEVELOPER_Projects\\SRC\\Fonte\\IBG\\cecom_2025\\node_modules',
npm WARN cleanup     [Error: EPERM: operation not permitted, rmdir 'F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025\node_modules\@prisma\studio-core'] {
npm WARN cleanup       errno: -4048,
npm WARN cleanup       code: 'EPERM',
npm WARN cleanup       syscall: 'rmdir',
npm WARN cleanup       path: 'F:\\DEVELOPER_Projects\\SRC\\Fonte\\IBG\\cecom_2025\\node_modules\\@prisma\\studio-core'
npm WARN cleanup     }
npm WARN cleanup   ],
npm WARN cleanup   [
npm WARN cleanup     'F:\\DEVELOPER_Projects\\SRC\\Fonte\\IBG\\cecom_2025\\node_modules\\@prisma',
npm WARN cleanup     [Error: EPERM: operation not permitted, rmdir 'F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025\node_modules\@prisma\fetch-engine'] {
npm WARN cleanup       errno: -4048,
npm WARN cleanup       code: 'EPERM',
npm WARN cleanup       syscall: 'rmdir',
npm WARN cleanup       path: 'F:\\DEVELOPER_Projects\\SRC\\Fonte\\IBG\\cecom_2025\\node_modules\\@prisma\\fetch-engine'
npm WARN cleanup     }
npm WARN cleanup   ]
npm WARN cleanup ]
npm ERR! code 1
npm ERR! path F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025\node_modules\prisma
npm ERR! command failed
npm ERR! command C:\WINDOWS\system32\cmd.exe /d /s /c node scripts/preinstall-entry.js
npm ERR! ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
npm ERR! ‚îÇ    Prisma only supports Node.js versions 20.19+, 22.12+, 24.0+.    ‚îÇ
npm ERR! ‚îÇ    Please upgrade your Node.js version.                            ‚îÇ
npm ERR! ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

npm ERR! A complete log of this run can be found in: C:\Users\joaos\AppData\Local\npm-cache\_logs\2025-12-04T00_33_43_630Z-debug-0.log

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>nvm list

  * 20.12.2 (Currently using 64-bit executable)

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>nvm install 20.19.1
Downloading node.js version 20.19.1 (64-bit)...
Extracting node and npm...
Complete
Installation complete.
If you want to use this version, type:

nvm use 20.19.1

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>nvm use 20.19.1
Now using node v20.19.1 (64-bit)

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>nvm list

  * 20.19.1 (Currently using 64-bit executable)
    20.12.2

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>node -v
v20.19.1

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm -v
10.8.2

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm install
npm error code ENOENT
npm error syscall open
npm error path F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025\package.json
npm error errno -4058
npm error enoent Could not read package.json: Error: ENOENT: no such file or directory, open 'F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025\package.json'
npm error enoent This is related to npm not being able to find a file.
npm error enoent
npm error A complete log of this run can be found in: C:\Users\joaos\AppData\Local\npm-cache\_logs\2025-12-04T00_41_54_158Z-debug-0.log

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm init -y
Wrote to F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025\package.json:

{
  "name": "cecom_2025",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": ""
}




(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>npm create vite@latest . -- --template react
Need to install the following packages:
create-vite@8.2.0
Ok to proceed? (y) y


> cecom_2025@1.0.0 npx
> create-vite . --template react

|
o  Current directory is not empty. Please choose how to proceed:
|  Remove existing files and continue
|
o  Use rolldown-vite (Experimental)?:
|  No
|
o  Install with npm and start now?
|  Yes
|
o  Scaffolding project in F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025...
|
o  Installing dependencies with npm...

added 157 packages, and audited 158 packages in 34s

33 packages are looking for funding
  run `npm fund` for details

found 0 vulnerabilities
|
o  Starting dev server...

> cecom_2025@0.0.0 dev
> vite


  VITE v7.2.6  ready in 539 ms

  ‚ûú  Local:   http://localhost:5173/
  ‚ûú  Network: use --host to expose
  ‚ûú  press h + enter to show help
Deseja finalizar o arquivo em lotes (S/N)? S

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>
(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025>cd..

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG>cd F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1>git init
Initialized empty Git repository in F:/DEVELOPER_Projects/SRC/Fonte/IBG/cecom_2025_1/.git/

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1>cd cecom.saude.web

(base) F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1\cecom.saude.web>

npm install @mui/material @emotion/react @emotion/styled


API
F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1\cecom.saude.api>npm install express cors dotenv

npm install @prisma/client

Initialized Prisma in your project

  prisma/
    schema.prisma
  prisma.config.ts
  .env
  .gitignore

Next, choose how you want to set up your database:

CONNECT EXISTING DATABASE:
  1. Configure your DATABASE_URL in prisma.config.ts
  2. Run prisma db pull to introspect your database.

CREATE NEW DATABASE:
  Local: npx prisma dev (runs Postgres locally in your terminal)
  Cloud: npx create-db (creates a free Prisma Postgres database)

Then, define your models in prisma/schema.prisma and run prisma migrate dev to apply your schema.

Learn more: https://pris.ly/getting-started



------------------------------ 04/12/2025

npm install prisma @types/node @types/pg --save-dev
npm install @prisma/client @prisma/adapter-pg pg dotenv

npx prisma init --datasource-provider postgresql --output ../generated/prisma

Alterar o arquivo .env no projeto api

	- Incluir a entrada de conex√£o com o Neon (connect)
	
	-- Cria√ß√£o do Cleinte para conectar com o banco
	npx prisma generate	

7. Instantiate Prisma Client
Create a utility file to instantiate Prisma Client. You need to pass an instance of Prisma ORM's driver adapter to the PrismaClient constructor:

lib/prisma.ts

import "dotenv/config";
import { PrismaPg } from '@prisma/adapter-pg'
import { PrismaClient } from '../generated/prisma/client'

const connectionString = `${process.env.DATABASE_URL}`

const adapter = new PrismaPg({ connectionString })
const prisma = new PrismaClient({ adapter })

export { prisma }

npx prisma migrate dev --name initial_migration

F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1\cecom.saude.api>npx prisma migrate dev --name initial_migration
Loaded Prisma config from prisma.config.ts.

Prisma schema loaded from prisma\schema.prisma
Datasource "db": PostgreSQL database "neondb", schema "public" at "ep-purple-grass-accsrtnk.sa-east-1.aws.neon.tech"

Applying migration `20251204154644_initial_migration`

The following migration(s) have been created and applied from new schema changes:

prisma\migrations/
  ‚îî‚îÄ 20251204154644_initial_migration/
    ‚îî‚îÄ migration.sql

Your database is now in sync with your schema.


F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1\cecom.saude.api>


model Cargo {
  id        Int      @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao String   @db.VarChar(50)
  cdNivel   Int?     @db.Integer
  stInativo SimNao?  @map("stInativo")

  @@map("cecom.cargos")
}

model Escolaridade {
  id        Int      @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao String   @db.VarChar(50)
  stInativo SimNao?  @map("stInativo")

  @@map("cecom.escolaridades")
}

model Horario {
  id            Int       @id @db.SmallInt @map("codigo")
  stUsoRestrito SimNao?   @map("stUsoRestrito")
  descricao     String    @db.VarChar(50) @map("dsHorario")
  hrInicio      DateTime  @db.Timestamptz @map("hrInicio")
  hrFim         DateTime? @db.Timestamptz @map("hrFim")
  stInativo     SimNao?   @map("stInativo")

  @@map("cecom.horarios")
}

model LocalAtendimento {
  id           Int      @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao    String   @db.VarChar(100)
  siglaUnidade String?  @db.VarChar(10)
  endereco     String?  @db.VarChar(150)
  telefone     String?  @db.VarChar(50)

  @@map("cecom.locaisatendimentos")
}

model MotivoDesistencia {
  id        Int    @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao String @db.VarChar(50)

  @@map("cecom.motivosdesistencia")
}

model MotivoExclamacao {
  id        Int      @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao String   @db.VarChar(50)
  stInativo SimNao?  @map("stInativo")

  @@map("cecom.motivosexclamacao")
}

model Ocupacao {
  id              Int      @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao       String   @db.VarChar(250)
  ocupacao        String?  @db.VarChar(10)
  cdOcupacaoPai   Int?     @db.SmallInt @map("cd_ocupacaopai")
  stInativo       SimNao?  @map("stInativo")

  ocupacaoPai     Ocupacao? @relation("OcupacaoPai", fields: [cdOcupacaoPai], references: [id])
  subocupacoes    Ocupacao[] @relation("OcupacaoPai")

  @@map("cecom.ocupacoes")
}

model Pais {
  id            Int      @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao     String   @db.VarChar(35)
  nacionalidade String?  @db.VarChar(50)
  cdIbge        Int?     @db.Integer @map("cdIbge")

  cidades       Cidade[]

  @@map("cecom.paises")
}

model Plano {
  id             Int       @id @db.SmallInt @map("codigo")
  descricao      String    @db.VarChar(50)
  valor          Decimal   @db.Decimal(12,2)
  qtdProfissionais Int     @db.SmallInt @map("qtd_profissinais")
  qtdClinicas     Int      @db.SmallInt @map("qtd_clinicas")
  validadeInicio  DateTime @db.Timestamptz @map("validade_inicio")
  validadeFinal   DateTime? @db.Timestamptz @map("validade_final")
  stInativo       SimNao?  @map("stInativo")

  @@map("cecom.planos")
}

model TipoEvolucao {
  id        Int    @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao String @db.VarChar(50)

  @@map("cecom.tiposevolucoes")
}

model TipoProcedimento {
  id        Int    @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao String @db.VarChar(50)

  @@map("cecom.tiposprocedimentos")
}

model TipoRecebimento {
  id        Int    @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao String @db.VarChar(50)

  @@map("cecom.tiposrecebimento")
}

model UnidadeFederacao {
  id        String @id @db.VarChar(2) @map("codigo")
  descricao String @db.VarChar(100)

  @@map("cecom.unidadesfederacao")
}

model Cidade {
  id         Int      @id @default(autoincrement()) @db.SmallInt @map("codigo")
  descricao  String   @db.VarChar(100)
  cdUf       String   @db.VarChar(2) @map("cdUf")
  cdPais     Int      @db.SmallInt @map("cdPais")
  cepGeral   String   @db.VarChar(9) @map("cepGeral")
  cdIbge     Int?     @db.Integer @map("cdIbge")
  stInativo  SimNao?  @map("stInativo")

  // Rela√ß√£o com Pais
  pais        Pais            @relation(fields: [cdPais], references: [id])

  // Rela√ß√£o com UnidadeFederacao
  unidadeFederacao UnidadeFederacao @relation(fields: [cdUf], references: [id])

  @@map("cecom.cidades")
}



toda vez que criar novas tabelas ou alterar existentes...

npx prisma migrate initial_migration

SE O BANCO J√Å EXISTE E J√Å TEM TABELAS CECOM CRIADAS MANUALMENTE

npx prisma migrate dev --name alguma_descricao_do_que_foi_mudado

SE (e somente se) aparecer drift detected:
npx prisma migrate reset

npx prisma migrate dev --name module4



PS F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1\cecom.saude.api> npx prisma migrate dev --name module38
Loaded Prisma config from prisma.config.ts.

Prisma schema loaded from prisma\schema.prisma
Datasource "db": PostgreSQL database "postgres", schema "cecom" at "localhost:5432"


Error: Prisma schema validation - (validate wasm)
Error code: P1012
error: Type "Paciente" is neither a built-in type, nor refers to another model, composite type, or enum.
  -->  prisma\schema.prisma:267
   | 
266 |   endereco   Endereco @relation(fields: [cdEndereco], references: [id])
267 |   paciente   Paciente @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente])
   | 
error: Type "Profissional" is neither a built-in type, nor refers to another model, composite type, or enum.
  -->  prisma\schema.prisma:280
   | 
279 |   endereco   Endereco      @relation(fields: [cdEndereco], references: [id])
280 |   profissional Profissional @relation(fields: [cdProf], references: [id])
   | 

Validation Error Count: 2
[Context: validate]

Prisma CLI Version : 7.1.0
PS F:\DEVELOPER_Projects\SRC\Fonte\IBG\cecom_2025_1\cecom.saude.api> 



ALTER TABLE cecom.enderecospacientes
  DROP CONSTRAINT IF EXISTS enderecospacientes_cdMaster_cdPaciente_fkey,
  ADD CONSTRAINT enderecospacientes_cdMaster_cdPaciente_fkey
    FOREIGN KEY (cdMaster, cdPaciente)
    REFERENCES cecom.pacientes (cdMaster, cdPaciente)
    ON DELETE CASCADE;
	
ALTER TABLE cecom.contatospacientes
  DROP CONSTRAINT IF EXISTS contatospacientes_cdMaster_cdPaciente_fkey,
  ADD CONSTRAINT contatospacientes_cdMaster_cdPaciente_fkey
    FOREIGN KEY (cdMaster, cdPaciente)
    REFERENCES cecom.pacientes (cdMaster, cdPaciente)
    ON DELETE CASCADE;

ALTER TABLE cecom.parentescospacientes
  DROP CONSTRAINT IF EXISTS parentescospacientes_cdMaster_cdPaciente_fkey,
  ADD CONSTRAINT parentescospacientes_cdMaster_cdPaciente_fkey
    FOREIGN KEY (cdMaster, cdPaciente)
    REFERENCES cecom.pacientes (cdMaster, cdPaciente)
    ON DELETE CASCADE;

ALTER TABLE cecom.atendimentos
  DROP CONSTRAINT IF EXISTS atendimentos_cdMaster_cdPaciente_fkey,
  ADD CONSTRAINT atendimentos_cdMaster_cdPaciente_fkey
    FOREIGN KEY (cdMaster, cdPaciente)
    REFERENCES cecom.pacientes (cdMaster, cdPaciente)
    ON DELETE CASCADE;


ALTER TABLE cecom.enderecosprofissionais
  DROP CONSTRAINT IF EXISTS enderecosprofissionais_cdProf_fkey,
  ADD CONSTRAINT enderecosprofissionais_cdProf_fkey
    FOREIGN KEY (cdProf)
    REFERENCES cecom.profissionais (id)
    ON DELETE CASCADE;

ALTER TABLE cecom.contatosprofissionais
  DROP CONSTRAINT IF EXISTS contatosprofissionais_cdProf_fkey,
  ADD CONSTRAINT contatosprofissionais_cdProf_fkey
    FOREIGN KEY (cdProf)
    REFERENCES cecom.profissionais (id)
    ON DELETE CASCADE;

ALTER TABLE cecom.evolucoes
  DROP CONSTRAINT IF EXISTS evolucoes_cdProf_fkey,
  ADD CONSTRAINT evolucoes_cdProf_fkey
    FOREIGN KEY (cdProf)
    REFERENCES cecom.profissionais (id)
    ON DELETE SET NULL;

ALTER TABLE cecom.atendimentos
  DROP CONSTRAINT IF EXISTS atendimentos_cdProf_fkey,
  ADD CONSTRAINT atendimentos_cdProf_fkey
    FOREIGN KEY (cdProf)
    REFERENCES cecom.profissionais (id)
    ON DELETE SET NULL;

ALTER TABLE cecom.evolucoes
  DROP CONSTRAINT IF EXISTS evolucoes_cdAtendimento_fkey,
  ADD CONSTRAINT evolucoes_cdAtendimento_fkey
    FOREIGN KEY (cdAtendimento)
    REFERENCES cecom.atendimentos (id)
    ON DELETE CASCADE;


ALTER TABLE cecom.sinaisvitais
  DROP CONSTRAINT IF EXISTS sinaisvitais_cdAtendimento_fkey,
  ADD CONSTRAINT sinaisvitais_cdAtendimento_fkey
    FOREIGN KEY (cdAtendimento)
    REFERENCES cecom.atendimentos (id)
    ON DELETE CASCADE;

ALTER TABLE cecom.evolucoescid
  DROP CONSTRAINT IF EXISTS evolucoescid_cdEvolucao_fkey,
  ADD CONSTRAINT evolucoescid_cdEvolucao_fkey
    FOREIGN KEY (cdEvolucao)
    REFERENCES cecom.evolucoes (id)
    ON DELETE CASCADE;

ALTER TABLE cecom.evolucoesdsm
  DROP CONSTRAINT IF EXISTS evolucoesdsm_cdEvolucao_fkey,
  ADD CONSTRAINT evolucoesdsm_cdEvolucao_fkey
    FOREIGN KEY (cdEvolucao)
    REFERENCES cecom.evolucoes (id)
    ON DELETE CASCADE;

ALTER TABLE cecom.enderecospessoasrelacionadas
  DROP CONSTRAINT IF EXISTS enderecospessoasrelacionadas_cdPessoa_fkey,
  ADD CONSTRAINT enderecospessoasrelacionadas_cdPessoa_fkey
    FOREIGN KEY (cdPessoa)
    REFERENCES cecom.pessoasrelacionadas (id)
    ON DELETE CASCADE;


======== ATEN√á√ÉO 1:
Melhor resultado do migrate:

	====>>>> npx prisma format

	====>>>> npx prisma migrate dev --name alguma_descricao_do_que_foi_mudado

======== ATEN√á√ÉO 2:
Pode (e deve) ser executado sempre que:

mudar o schema.prisma

atualizar Prisma

surgir erro estranho de tipos

trocar de m√°quina

clonar o projeto

	====>>>> npx prisma generate

	====>>>> npm run prisma:generate
	====>>>> npx prisma@7.1.0 generate
	
	
SUBIR ALTERA√á√ïES	
git add ../package.json	
git commit -m "Corre√ß√µes para executar npm run dev com sucesso..."
git push --set-upstream origin main












### prisma.ts
import "dotenv/config";
import { PrismaClient } from "@prisma/client";
import { Pool } from "pg";
import { PrismaPg } from "@prisma/adapter-pg";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
});

const adapter = new PrismaPg(pool);

const prisma = new PrismaClient({ adapter });

export default prisma;

### env.ts
# Environment variables declared in this file are NOT automatically loaded by Prisma.
# Please add `import "dotenv/config";` to your `prisma.config.ts` file, or use the Prisma CLI with Bun
# to load environment variables from .env files: https://pris.ly/prisma-config-env-vars.

# Prisma supports the native connection string format for PostgreSQL, MySQL, SQLite, SQL Server, MongoDB and CockroachDB.
# See the documentation for all the connection string options: https://pris.ly/d/connection-strings

# The following `prisma+postgres` URL is similar to the URL produced by running a local Prisma Postgres
# server with the `prisma dev` CLI command, when not choosing any non-default ports or settings. The API key, unlike the
# one found in a remote Prisma Postgres URL, does not contain any sensitive information.

# SARAH
DATABASE_URL="postgresql://postgres:tWdy8ilnp001@localhost:5432/postgres?schema=cecom"


### server.ts

import "dotenv/config";
import app from "./app";
import prisma from "./config/prisma";

const PORT = Number(process.env.PORT ?? 3000);

async function bootstrap() {
  await prisma.$connect();
  console.log("Prisma conectado com sucesso.");

  app.listen(PORT, () => {
    console.log(`üöÄ API CECOM rodando na porta ${PORT}`);
  });
}

bootstrap().catch((err) => {
  console.error("Falha ao iniciar a API:", err);
  process.exit(1);
});

### routes.ts (arquivo vazio)

### profissional.controller.ts

import { Request, Response } from "express";
import { ProfissionalService } from "./profissional.service";
import { ProfissionalCreateDTO } from "./profissional.dto";

const service = new ProfissionalService();

export class ProfissionalController {
  async criar(req: Request, res: Response) {
    const parsed = ProfissionalCreateDTO.safeParse(req.body);
    if (!parsed.success) return res.status(400).json(parsed.error.format());

    try {
      const profissional = await service.criar(parsed.data);
      return res.status(201).json(profissional);
    } catch (err: any) {
      return res.status(500).json({ message: "Erro ao criar profissional", detail: String(err?.message ?? err) });
    }
  }

  async listar(req: Request, res: Response) {
    const profissionais = await service.listar();
    return res.json(profissionais);
  }
}

### profissional.dto.ts

import { z } from "zod";

export const ProfissionalCreateDTO = z.object({
  cdMaster: z.number().int().positive(),
  nome: z.string().min(3).max(120),

  sexo: z.enum(["M", "F", "I"]).optional(),
  conselho: z.string().max(30).optional(),

  stInativo: z.enum(["S", "N"]).optional(),
  cdOcupacao: z.number().int().positive().optional(),
});

export type ProfissionalCreateInput = z.infer<typeof ProfissionalCreateDTO>;

### profissional.router.ts

import { Router } from "express";
import { ProfissionalController } from "./profissional.controller";

const router = Router();
const controller = new ProfissionalController();

// router.post("/", (req, res) => controller.criar(req, res));
// router.get("/", (req, res) => controller.listar(req, res));

router.post("/", controller.criar.bind(controller));
router.get("/", controller.listar.bind(controller));

export default router;

### profissional.service.ts

import prisma from "../../config/prisma";
import { ProfissionalCreateInput } from "./profissional.dto";

export class ProfissionalService {
  async criar(data: ProfissionalCreateInput) {
    return prisma.profissional.create({ data });
  }

  async listar() {
    return prisma.profissional.findMany({
      include: {
        enderecos: { include: { endereco: true } },
        contatos: { include: { contato: true } },
        ocupacao: true, // opcional, mas √∫til
        master: true,   // opcional, mas √∫til
      },
    });
  }

  // ‚úÖ aqui o correto: cdMaster + id do profissional
  async buscarPorId(cdMaster: number, id: number) {
    return prisma.profissional.findFirst({
      where: { id, cdMaster },
    });
  }
  
}


### auth/ (nenhum arquivo nesta pasta)

### package.json

{
  "name": "cecom.saude.api",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "dev": "tsx watch src/server.ts",
    "build": "tsc",
    "start": "node dist/server.js",
    "prisma:generate": "prisma generate",
    "prisma:migrate": "prisma migrate dev"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "description": "",
  "dependencies": {
    "@prisma/adapter-pg": "^7.1.0",
    "@prisma/client": "^7.1.0",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "pg": "^8.16.3",
    "zod": "^4.2.1"
  },
  "devDependencies": {
    "@types/node": "^24.10.2",
    "@types/pg": "^8.15.6",
    "prisma": "^7.1.0"
  }
}

### model Profissional

model Profissional {
  id       Int @id @default(autoincrement()) @db.Integer
  cdMaster Int @map("cdMaster")

  nome      String  @db.VarChar(120)
  sexo      Sexo?   @map("sexo")
  conselho  String? @map("conselho") @db.VarChar(30)
  stInativo SimNao? @map("stInativo")

  cdOcupacao Int?      @map("cdOcupacao")
  ocupacao   Ocupacao? @relation(fields: [cdOcupacao], references: [id])

  master Master @relation(fields: [cdMaster], references: [id])

  enderecos         EnderecoProfissional[]
  contatos          ContatoProfissional[]
  atendimentos      Atendimento[]
  evolucoes         Evolucao[]
  glasgows          Glasgow[]
  afericoesClinicas AfericaoClinica[]
  evaDores          EvaDor[]

  @@map("cecom.profissionais")
}







3) Auth endpoints (m√≠nimo para publicar beta)
3.1 Depend√™ncias do backend

Voc√™ j√° tem zod. Instale s√≥ o necess√°rio:

npm i jsonwebtoken bcrypt
npm i -D @types/jsonwebtoken @types/bcrypt

3.2 .env m√≠nimo (backend)

No .env do cecom.saude.api:

DATABASE_URL=postgresql://...
JWT_SECRET=uma_chave_longa_aqui
PORT=3001

3.3 DTO (zod) do login

src/modules/auth/auth.dto.ts

import { z } from "zod";

export const LoginDTO = z.object({
  cdMaster: z.number().int().positive(),
  email: z.string().email().max(120),
  senha: z.string().min(6).max(200),
});

export type LoginInput = z.infer<typeof LoginDTO>;

3.4 Service (valida senha e gera JWT)

src/modules/auth/auth.service.ts

import prisma from "../../config/prisma";
import bcrypt from "bcrypt";
import jwt from "jsonwebtoken";

export class AuthService {
  async login(cdMaster: number, email: string, senha: string) {
    const user = await prisma.usuarioAuth.findFirst({
      where: { cdMaster, email, stInativo: { not: "S" } },
    });

    if (!user) return null;

    const ok = await bcrypt.compare(senha, user.senhaHash);
    if (!ok) return null;

    await prisma.usuarioAuth.update({
      where: { id: user.id },
      data: { dtUltLogin: new Date() },
    });

    const token = jwt.sign(
      { sub: user.id, cdMaster: user.cdMaster, role: user.role },
      process.env.JWT_SECRET!,
      { expiresIn: "8h" }
    );

    return { token };
  }
}

3.5 Controller + Router

src/modules/auth/auth.controller.ts

import { Request, Response } from "express";
import { LoginDTO } from "./auth.dto";
import { AuthService } from "./auth.service";

const service = new AuthService();

export class AuthController {
  async login(req: Request, res: Response) {
    const parsed = LoginDTO.safeParse(req.body);
    if (!parsed.success) return res.status(400).json(parsed.error.format());

    const { cdMaster, email, senha } = parsed.data;
    const result = await service.login(cdMaster, email, senha);

    if (!result) return res.status(401).json({ message: "Credenciais inv√°lidas" });
    return res.json(result);
  }
}


src/modules/auth/auth.router.ts

import { Router } from "express";
import { AuthController } from "./auth.controller";

const router = Router();
const controller = new AuthController();

router.post("/login", (req, res) => controller.login(req, res));

export default router;

3.6 Plug no app principal

src/routes.ts

import { Router } from "express";
import profissionalRouter from "./modules/profissionais/profissional.router";
import authRouter from "./modules/auth/auth.router";

const routes = Router();

routes.use("/auth", authRouter);
routes.use("/profissionais", profissionalRouter);

export default routes;


src/app.ts

import express from "express";
import cors from "cors";
import routes from "./routes";

const app = express();

app.use(cors());
app.use(express.json());
app.use(routes);

export default app;


src/server.ts

import "dotenv/config";
import app from "./app";

const port = Number(process.env.PORT ?? 3001);

app.listen(port, () => {
  console.log(`API rodando na porta ${port}`);
});

4) Criar a tela de login (frontend React) j√° alinhada ao passo 6

Como voc√™ pediu: a tela de login entra ‚Äúantes‚Äù do restante, para publicar beta.

Fluxo do frontend (beta)

Tela login:

cdMaster, email, senha

POST /auth/login

Salvar token (localStorage)

Redirecionar para tela simples ‚ÄúHome Beta‚Äù

Home Beta chama /profissionais (s√≥ para provar acesso) ‚Äî depois voc√™ evolui as rotas protegidas.

Importante: ainda que voc√™ n√£o proteja tudo agora, j√° deixe o ‚Äúesqueleto‚Äù de middleware JWT no backend para o item 6 (rotas protegidas + pap√©is + auditoria).

5) Pr√≥ximo m√≥dulo cl√≠nico depois disso

Com login + base rodando, a√≠ sim seguimos sua trilha cl√≠nica:

Escala EVA (Dor) como tabela pr√≥pria (igual Glasgow)

Braden, Morse, RASS, etc (cada escala em tabela pr√≥pria)

Registrar tudo em AfericaoClinica (sua op√ß√£o 3 h√≠brida) apontando:

escala = "EVA"

idRegistro = id da evaDor

Vincular aferi√ß√µes a Atendimento e, opcional, Profissional.

Voc√™ j√° viu o erro ‚Äúmissing opposite relation field‚Äù: sempre que criar EvaDor com rela√ß√£o Atendimento, adicione o array do outro lado (Atendimento.evaDores EvaDor[]) e, se tiver, Profissional.evaDores EvaDor[].

6) Ajuste cir√∫rgico do seu m√≥dulo ‚ÄúProfissionais‚Äù (o que j√° est√° OK e o que falta)

Pelo que voc√™ colou, seu m√≥dulo est√° OK agora:

criar usando prisma.profissional.create({ data }) ‚úÖ

listar incluindo enderecos e contatos ‚úÖ

buscarPorId(cdMaster, id) usando findFirst({ where: { id, cdMaster } }) ‚úÖ (boa decis√£o)

S√≥ um detalhe: se voc√™ quiser ‚Äúunique de verdade‚Äù por (cdMaster, id) voc√™ pode criar um @@unique([id, cdMaster]) no Prisma ‚Äî mas no Postgres hoje id j√° √© PK e suficiente; o cdMaster entra s√≥ como filtro/tenant guard.

7) O que voc√™ faz agora (checklist imediato)

Criar model UsuarioAuth + enum RoleAuth no schema

npx prisma migrate dev --name module_auth_usuario

Instalar bcrypt + jsonwebtoken

Criar src/modules/auth/* (dto/service/controller/router)

Ligar routes.ts no app.ts

Rodar:

npm run dev


Testar login via Insomnia/Postman:

POST /auth/login

S√≥ ent√£o criar a tela de login no React (Vite) apontando para essa rota.

Se voc√™ me disser se o login beta ser√° ‚Äúpor Profissional‚Äù (e-mail/senha) ou ‚Äúpor Master/Admin‚Äù primeiro, eu j√° te devolvo o schema final do Auth (com seed inicial de usu√°rio ADMIN do Master) e um exemplo de POST completo para testar no Insomnia.