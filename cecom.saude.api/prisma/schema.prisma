generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  schemas  = ["cecom"]
}

//--- datasource db {
//---   provider = "postgresql"
//---   url      = env("DATABASE_URL")
//---   schemas  = ["cecom"]
//--- }

//---------------------------------------------
// ENUMS GLOBAIS ‚Äî derivados das constraints S/N e outras
//---------------------------------------------
enum SimNao {
  S
  N

  @@schema("cecom")
}

enum Sexo {
  M
  F
  I

  @@schema("cecom")
}

enum VersaoCid {
  c9
  c10

  @@schema("cecom")
}

enum VersaoDsm {
  d4
  d5

  @@schema("cecom")
}

enum HumorIntensidade {
  NIVEL_1 @map("1")
  NIVEL_2 @map("2")
  NIVEL_3 @map("3")
  NIVEL_4 @map("4")
  NIVEL_5 @map("5")

  @@schema("cecom")
}

enum OrigemAfericao {
  MANUAL
  OXIMETRO
  BALANCA
  RELOGIO_INTELIGENTE
  MONITOR_HOSPITALAR

  @@schema("cecom")
}

enum PosicaoPaciente {
  SENTADO
  DEITADO
  ORTOSTATICO
  EM_PE

  @@schema("cecom")
}

model Master {
  id         Int      @id @default(autoincrement()) @map("codigo") @db.Integer
  nome       String   @map("nome") @db.VarChar(120)
  dtCadastro DateTime @default(now()) @map("dtCadastro") @db.Timestamptz
  stInativo  SimNao?  @map("stInativo")

  pacientes     Paciente[]
  profissionais Profissional[]
  usuarioAuths  UsuarioAuth[]

  @@map("master")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 2 ‚Äî MODELOS MVP (Simples e sem depend√™ncias)
//-------------------------------------------------------

model Paciente {
  cdMaster   Int
  cdPaciente Int

  nome         String    @db.VarChar(120)
  sexo         Sexo?     @map("sexo")
  dtNascimento DateTime? @map("dtNascimento") @db.Date
  stInativo    SimNao?   @map("stInativo")

  cdEscolaridade Int? @map("cdEscolaridade")
  cdOcupacao     Int? @map("cdOcupacao")

  escolaridade Escolaridade? @relation(fields: [cdEscolaridade], references: [id])
  ocupacao     Ocupacao?     @relation(fields: [cdOcupacao], references: [id])

  master              Master               @relation(fields: [cdMaster], references: [id])
  enderecos           EnderecoPaciente[]
  contatos            ContatoPaciente[]
  atendimentos        Atendimento[]
  evolucoes           Evolucao[]
  parentescoPacientes ParentescoPaciente[]
  usuarioAuths        UsuarioAuth[]

  @@id([cdMaster, cdPaciente])
  @@map("pacientes")
  @@schema("cecom")
}

model Profissional {
  id       Int @id @default(autoincrement()) @db.Integer
  cdMaster Int @map("cdMaster")

  nome      String  @db.VarChar(120)
  sexo      Sexo?   @map("sexo")
  conselho  String? @map("conselho") @db.VarChar(30)
  stInativo SimNao? @map("stInativo")

  cdOcupacao Int?      @map("cdOcupacao")
  ocupacao   Ocupacao? @relation(fields: [cdOcupacao], references: [id])

  master Master @relation(fields: [cdMaster], references: [id])

  enderecos         EnderecoProfissional[]
  contatos          ContatoProfissional[]
  atendimentos      Atendimento[]
  evolucoes         Evolucao[]
  glasgows          Glasgow[]
  afericoesClinicas AfericaoClinica[]
  evaDores          EvaDor[]
  usuarioAuths      UsuarioAuth[]

  @@map("profissionais")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 3 ‚Äî ENDERE√áOS (MVP sem depend√™ncias externas)
//-------------------------------------------------------

model Endereco {
  id          Int     @id @default(autoincrement()) @db.Integer
  logradouro  String  @db.VarChar(120)
  numero      String? @db.VarChar(10)
  complemento String? @db.VarChar(50)
  cdBairro    Int
  cdCidade    Int
  cep         String  @db.VarChar(9)
  stInativo   SimNao? @map("stInativo")

  cidade Cidade @relation(fields: [cdCidade], references: [id])
  bairro Bairro @relation(fields: [cdBairro], references: [id])

  pacientes                  EnderecoPaciente[]
  profissionais              EnderecoProfissional[]
  enderecoPessoaRelacionadas EnderecoPessoaRelacionada[]

  @@map("enderecos")
  @@schema("cecom")
}

model EnderecoPaciente {
  id         Int @id @default(autoincrement()) @db.Integer
  cdMaster   Int
  cdPaciente Int
  cdEndereco Int

  paciente Paciente @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente])
  endereco Endereco @relation(fields: [cdEndereco], references: [id])

  @@map("enderecospacientes")
  @@schema("cecom")
}

model EnderecoProfissional {
  id         Int @id @default(autoincrement()) @db.Integer
  cdProf     Int
  cdEndereco Int

  profissional Profissional @relation(fields: [cdProf], references: [id])
  endereco     Endereco     @relation(fields: [cdEndereco], references: [id])

  @@map("enderecosprofissionais")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 4 ‚Äî CONTATOS (MVP sem depend√™ncias externas)
//-------------------------------------------------------

enum TipoFone {
  R // Residencial
  T // Trabalho
  C // Celular
  P // Principal

  @@schema("cecom")
}

model Contato {
  id        Int      @id @default(autoincrement()) @db.Integer
  tipo      TipoFone @map("tpTelefone")
  numero    String   @db.VarChar(20)
  stInativo SimNao?  @map("stInativo")

  pacientes     ContatoPaciente[]
  profissionais ContatoProfissional[]

  @@map("contatos")
  @@schema("cecom")
}

model ContatoPaciente {
  id         Int @id @default(autoincrement()) @db.Integer
  cdMaster   Int
  cdPaciente Int
  cdContato  Int

  paciente Paciente @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente])
  contato  Contato  @relation(fields: [cdContato], references: [id])

  @@map("contatospacientes")
  @@schema("cecom")
}

model ContatoProfissional {
  id        Int @id @default(autoincrement()) @db.Integer
  cdProf    Int
  cdContato Int

  profissional Profissional @relation(fields: [cdProf], references: [id])
  contato      Contato      @relation(fields: [cdContato], references: [id])

  @@map("contatosprofissionais")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 5 ‚Äî ATENDIMENTO (MVP sem depend√™ncias externas)
//-------------------------------------------------------

model Atendimento {
  id             Int      @id @default(autoincrement())
  cdMaster       Int
  cdPaciente     Int
  cdProfissional Int      @map("cdProf")
  data           DateTime @db.Timestamptz
  observacao     String?  @db.VarChar(500)

  paciente     Paciente     @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente], onDelete: Cascade)
  profissional Profissional @relation(fields: [cdProfissional], references: [id], onDelete: Restrict)

  evolucoes         Evolucao[]
  sinaisVitais      SinaisVitais[]
  glasgows          Glasgow[]
  afericoesClinicas AfericaoClinica[]
  evaDores          EvaDor[]

  @@map("atendimentos")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 6 ‚Äî EVOLU√á√ÉO CL√çNICA (MVP)
//-------------------------------------------------------

model Evolucao {
  id             Int      @id @default(autoincrement())
  cdAtendimento  Int
  cdProfissional Int?
  data           DateTime @db.Timestamptz
  texto          String   @db.VarChar(2000)

  atendimento  Atendimento   @relation(fields: [cdAtendimento], references: [id], onDelete: Cascade)
  profissional Profissional? @relation(fields: [cdProfissional], references: [id], onDelete: SetNull)

  pacienteCdMaster   Int?
  pacienteCdPaciente Int?

  paciente Paciente? @relation(fields: [pacienteCdMaster, pacienteCdPaciente], references: [cdMaster, cdPaciente], onDelete: SetNull)

  cid                   EvolucaoCid[]
  dsm                   EvolucaoDsm[]
  tipoEvolucaoClinica   TipoEvolucaoClinica? @relation(fields: [tipoEvolucaoClinicaId], references: [id])
  tipoEvolucaoClinicaId Int?                 @db.Integer

  @@map("evolucoes")
  @@schema("cecom")
}

enum TipoParentesco {
  P // Pai
  M // M√£e
  T // Tutor
  F // Filho(a)
  C // C√¥njuge
  O // Outro
  R // Pr√≥prio paciente

  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 7 ‚Äî PESSOAS RELACIONADAS (MVP)
//-------------------------------------------------------

model PessoaRelacionada {
  id        Int     @id @default(autoincrement()) @db.Integer
  nome      String  @db.VarChar(120)
  telefone  String? @db.VarChar(20)
  stInativo SimNao? @map("stInativo")

  parentescos ParentescoPaciente[]
  enderecos   EnderecoPessoaRelacionada[]

  @@map("pessoasrelacionadas")
  @@schema("cecom")
}

model ParentescoPaciente {
  id         Int            @id @default(autoincrement()) @db.Integer
  cdMaster   Int
  cdPaciente Int
  cdPessoa   Int
  parentesco TipoParentesco @map("tipo")

  paciente          Paciente          @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente])
  pessoaRelacionada PessoaRelacionada @relation(fields: [cdPessoa], references: [id])

  @@map("parentescospacientes")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 8 ‚Äî TABELAS AUXILIARES (MVP)
//-------------------------------------------------------

model Plano {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(120)
  stInativo SimNao? @map("stInativo")

  @@map("planos")
  @@schema("cecom")
}

model Motivo {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(200)
  stInativo SimNao? @map("stInativo")

  @@map("motivos")
  @@schema("cecom")
}

model TipoProcedimento {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(120)
  stInativo SimNao? @map("stInativo")

  @@map("tiposprocedimentos")
  @@schema("cecom")
}

model TipoEvolucaoSimples {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(120)
  stInativo SimNao? @map("stInativo")

  @@map("tiposevolucaosimples")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 9 ‚Äî LOCALIZA√á√ÉO COMPLETA (MVP Seguro)
//-------------------------------------------------------

model Pais {
  id            Int     @id @default(autoincrement()) @db.SmallInt
  descricao     String  @db.VarChar(60)
  nacionalidade String? @db.VarChar(60)
  cdIbge        Int?    @db.Integer

  cidades Cidade[]

  @@map("paises")
  @@schema("cecom")
}

model UnidadeFederacao {
  id        String @id @db.Char(2) // Ex.: 'BA', 'SP'
  descricao String @db.VarChar(60)
  cdIbge    Int?   @db.Integer

  cidades Cidade[]

  @@map("unidadesfederacao")
  @@schema("cecom")
}

model Cidade {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(120)
  cdUf      String  @db.Char(2)
  cdPais    Int
  cepGeral  String? @db.VarChar(9)
  cdIbge    Int?    @db.Integer
  stInativo SimNao? @map("stInativo")

  uf        UnidadeFederacao @relation(fields: [cdUf], references: [id])
  pais      Pais             @relation(fields: [cdPais], references: [id])
  enderecos Endereco[]
  distritos Distrito[]
  bairros   Bairro[]

  @@index([cdUf])
  @@index([cdPais])
  @@map("cidades")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 11 ‚Äî OCUPA√á√ïES E ESCOLARIDADE (MVP)
//-------------------------------------------------------

model Escolaridade {
  id        Int        @id @default(autoincrement()) @db.SmallInt
  descricao String     @db.VarChar(120)
  stInativo SimNao?    @map("stInativo")
  pacientes Paciente[]

  @@map("escolaridades")
  @@schema("cecom")
}

model Ocupacao {
  id            Int            @id @default(autoincrement()) @db.SmallInt
  descricao     String         @db.VarChar(120)
  cbo           String?        @db.VarChar(10)
  stInativo     SimNao?        @map("stInativo")
  pacientes     Paciente[]
  profissionals Profissional[]

  @@map("ocupacoes")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 13 ‚Äî LOCALIZA√á√ÉO AVAN√áADA (Bairro, Distrito)
//-------------------------------------------------------

model Distrito {
  id        Int     @id @default(autoincrement()) @db.Integer
  cdCidade  Int
  descricao String  @db.VarChar(120)
  stInativo SimNao? @map("stInativo")

  cidade  Cidade   @relation(fields: [cdCidade], references: [id])
  bairros Bairro[]

  @@map("distritos")
  @@schema("cecom")
}

model Bairro {
  id         Int     @id @default(autoincrement()) @db.Integer
  cdDistrito Int?
  cdCidade   Int
  descricao  String  @db.VarChar(120)
  stInativo  SimNao? @map("stInativo")

  distrito Distrito? @relation(fields: [cdDistrito], references: [id])
  cidade   Cidade    @relation(fields: [cdCidade], references: [id])

  enderecos Endereco[]

  @@map("bairros")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 14 ‚Äî ENDERE√áO PARA PESSOA RELACIONADA
//-------------------------------------------------------

model EnderecoPessoaRelacionada {
  id         Int @id @default(autoincrement()) @db.Integer
  cdPessoa   Int
  cdEndereco Int

  pessoaRelacionada PessoaRelacionada @relation(fields: [cdPessoa], references: [id])
  endereco          Endereco          @relation(fields: [cdEndereco], references: [id])

  @@map("enderecospessoasrelacionadas")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 15 ‚Äî CID, DSM E TIPO DE EVOLU√á√ÉO CL√çNICA
//-------------------------------------------------------

model Cid {
  id           Int           @id @default(autoincrement()) @db.Integer
  codigo       String        @db.VarChar(10)
  descricao    String        @db.VarChar(300)
  versao       VersaoCid
  stInativo    SimNao?       @map("stInativo")
  evolucaoCids EvolucaoCid[]

  @@unique([codigo, versao])
  @@map("cid")
  @@schema("cecom")
}

model Dsm {
  id           Int           @id @default(autoincrement()) @db.Integer
  codigo       String        @db.VarChar(10)
  descricao    String        @db.VarChar(300)
  versao       VersaoDsm
  stInativo    SimNao?       @map("stInativo")
  evolucaoDsms EvolucaoDsm[]

  @@unique([codigo, versao])
  @@map("dsm")
  @@schema("cecom")
}

// Tipos modernos de evolu√ß√£o cl√≠nica
model TipoEvolucaoClinica {
  id        Int        @id @default(autoincrement()) @db.Integer
  descricao String     @db.VarChar(120)
  stInativo SimNao?    @map("stInativo")
  evolucaos Evolucao[]

  @@map("tiposevolucoesclinicas")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 16 ‚Äî RELACIONAMENTO EVOLUCAO ‚Üî CID / DSM
//-------------------------------------------------------

model EvolucaoCid {
  id         Int @id @default(autoincrement()) @db.Integer
  cdEvolucao Int
  cdCid      Int

  evolucao Evolucao @relation(fields: [cdEvolucao], references: [id])
  cid      Cid      @relation(fields: [cdCid], references: [id])

  @@map("evolucoescid")
  @@schema("cecom")
}

model EvolucaoDsm {
  id         Int @id @default(autoincrement()) @db.Integer
  cdEvolucao Int
  cdDsm      Int

  evolucao Evolucao @relation(fields: [cdEvolucao], references: [id])
  dsm      Dsm      @relation(fields: [cdDsm], references: [id])

  @@map("evolucoesdsm")
  @@schema("cecom")
}

model SinaisVitais {
  id            Int      @id @default(autoincrement())
  cdAtendimento Int
  data          DateTime @default(now())

  // Press√£o arterial
  paSistolica  Int? @db.SmallInt
  paDiastolica Int? @db.SmallInt

  // Frequ√™ncias
  fc Int? @db.SmallInt
  fr Int? @db.SmallInt

  // Febre
  temperatura Decimal? @db.Decimal(4, 1)

  // Oxigena√ß√£o
  spo2 Int? @db.SmallInt

  // Medidas antropom√©tricas
  peso   Decimal? @db.Decimal(5, 2)
  altura Decimal? @db.Decimal(4, 2)
  imc    Decimal? @db.Decimal(5, 2)

  // Dor
  dor         Int?       @db.SmallInt
  escalaDorId Int?
  escalaDor   EscalaDor? @relation(fields: [escalaDorId], references: [id])

  // Posi√ß√£o do paciente
  posicao PosicaoPaciente?

  // Origem da aferi√ß√£o
  origem OrigemAfericao? @default(MANUAL)

  // Informa√ß√£o bruta (logs e integra√ß√µes)
  metadataRaw Json?

  atendimento Atendimento @relation(fields: [cdAtendimento], references: [id])

  @@map("sinaisvitais")
  @@schema("cecom")
}

model EscalaDor {
  id        Int     @id @default(autoincrement())
  nome      String  @db.VarChar(100) // Ex: EVA, NIPS, Wong-Baker
  descricao String? @db.VarChar(300)

  sinaisVitais SinaisVitais[]

  @@map("escalasdor")
  @@schema("cecom")
}

model Glasgow {
  id             Int      @id @default(autoincrement())
  cdAtendimento  Int
  cdProfissional Int?     @map("cdProf")
  data           DateTime @default(now()) @db.Timestamptz

  // Componentes da ECG
  ocular Int // 1‚Äì4
  verbal Int // 1‚Äì5
  motora Int // 1‚Äì6
  total  Int // 3‚Äì15, calculado pela API, salvo no banco

  observacao String? @db.VarChar(300)

  // Relacionamentos
  atendimento  Atendimento   @relation(fields: [cdAtendimento], references: [id])
  profissional Profissional? @relation(fields: [cdProfissional], references: [id])

  @@index([cdAtendimento])
  @@index([cdProfissional])
  @@map("glasgow")
  @@schema("cecom")
}

model AfericaoClinica {
  id             Int      @id @default(autoincrement())
  cdAtendimento  Int
  cdProfissional Int?     @map("cdProf")
  escala         String   @db.VarChar(50) // exemplo: 'GLASGOW', 'EVA', 'BRADEN'
  idRegistro     Int // id da tabela espec√≠fica (ex.: id da cecom.glasgow)
  data           DateTime @default(now()) @db.Timestamptz

  atendimento  Atendimento   @relation(fields: [cdAtendimento], references: [id])
  profissional Profissional? @relation(fields: [cdProfissional], references: [id])

  @@index([cdAtendimento])
  @@index([escala])
  @@map("afericoesclinicas")
  @@schema("cecom")
}

model EvaDor {
  id             Int      @id @default(autoincrement())
  cdAtendimento  Int
  cdProfissional Int?
  data           DateTime @default(now()) @db.Timestamptz

  valor      Int // 0 a 10
  observacao String? @db.VarChar(300)

  atendimento  Atendimento   @relation(fields: [cdAtendimento], references: [id])
  profissional Profissional? @relation(fields: [cdProfissional], references: [id])

  @@index([cdAtendimento])
  @@index([cdProfissional])
  @@map("eva")
  @@schema("cecom")
}

//-------------------------------------------------------
// M√ìDULO 17 ‚Äî Novo m√≥dulo/tabelas m√≠nimas para login
//-------------------------------------------------------

enum RoleAuth {
  ADMIN
  PROFISSIONAL
  LEITURA

  @@schema("cecom")
}

model UsuarioAuth {
  id        Int      @id @default(autoincrement())
  cdMaster  Int
  email     String   @db.VarChar(150)
  senhaHash String   @db.VarChar(255)
  role      RoleAuth @default(PROFISSIONAL)

  cdProfissional Int?
  cdPaciente     Int?

  // üîó rela√ß√µes
  master Master @relation(fields: [cdMaster], references: [id])

  profissional Profissional? @relation(fields: [cdProfissional], references: [id], onDelete: SetNull)
  paciente     Paciente?     @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente], onDelete: SetNull)

  @@unique([cdMaster, email])
  @@index([cdMaster])
  @@map("usuariosauth")
  @@schema("cecom")
}
