generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//---------------------------------------------
// ENUMS GLOBAIS — derivados das constraints S/N e outras
//---------------------------------------------
enum SimNao {
  S
  N
}

enum Sexo {
  M
  F
  I
}

enum VersaoCid {
  c9
  c10
}

enum VersaoDsm {
  d4
  d5
}

enum HumorIntensidade {
  NIVEL_1 @map("1")
  NIVEL_2 @map("2")
  NIVEL_3 @map("3")
  NIVEL_4 @map("4")
  NIVEL_5 @map("5")
}

enum OrigemAfericao {
  MANUAL
  OXIMETRO
  BALANCA
  RELOGIO_INTELIGENTE
  MONITOR_HOSPITALAR
}

enum PosicaoPaciente {
  SENTADO
  DEITADO
  ORTOSTATICO
  EM_PE
}

model Master {
  id         Int      @id @default(autoincrement()) @map("codigo") @db.Integer
  nome       String   @map("nome") @db.VarChar(120)
  dtCadastro DateTime @default(now()) @map("dtCadastro") @db.Timestamptz
  stInativo  SimNao?  @map("stInativo")

  pacientes     Paciente[]
  profissionais Profissional[]
  usuarioAuths  UsuarioAuth[]

  @@map("master")
}

//-------------------------------------------------------
// MÓDULO 2 — MODELOS MVP (Simples e sem dependências)
//-------------------------------------------------------

model Paciente {
  cdMaster   Int
  cdPaciente Int

  nome         String    @db.VarChar(120)
  sexo         Sexo?     @map("sexo")
  dtNascimento DateTime? @map("dtNascimento") @db.Date
  stInativo    SimNao?   @map("stInativo")

  cdEscolaridade Int? @map("cdEscolaridade")
  cdOcupacao     Int? @map("cdOcupacao")

  escolaridade Escolaridade? @relation(fields: [cdEscolaridade], references: [id])
  ocupacao     Ocupacao?     @relation(fields: [cdOcupacao], references: [id])

  master              Master               @relation(fields: [cdMaster], references: [id])
  enderecos           EnderecoPaciente[]
  contatos            ContatoPaciente[]
  atendimentos        Atendimento[]
  evolucoes           Evolucao[]
  parentescoPacientes ParentescoPaciente[]

  @@id([cdMaster, cdPaciente])
  @@map("pacientes")
}

model Profissional {
  id       Int @id @default(autoincrement()) @db.Integer
  cdMaster Int @map("cdMaster")

  nome      String  @db.VarChar(120)
  sexo      Sexo?   @map("sexo")
  conselho  String? @map("conselho") @db.VarChar(30)
  stInativo SimNao? @map("stInativo")

  cdOcupacao Int?      @map("cdOcupacao")
  ocupacao   Ocupacao? @relation(fields: [cdOcupacao], references: [id])

  master Master @relation(fields: [cdMaster], references: [id])

  enderecos         EnderecoProfissional[]
  contatos          ContatoProfissional[]
  atendimentos      Atendimento[]
  evolucoes         Evolucao[]
  glasgows          Glasgow[]
  afericoesClinicas AfericaoClinica[]
  evaDores          EvaDor[]
  usuarioAuths      UsuarioAuth[]

  @@map("profissionais")
}

//-------------------------------------------------------
// MÓDULO 3 — ENDEREÇOS (MVP sem dependências externas)
//-------------------------------------------------------

model Endereco {
  id          Int     @id @default(autoincrement()) @db.Integer
  logradouro  String  @db.VarChar(120)
  numero      String? @db.VarChar(10)
  complemento String? @db.VarChar(50)
  cdBairro    Int
  cdCidade    Int
  cep         String  @db.VarChar(9)
  stInativo   SimNao? @map("stInativo")

  cidade Cidade @relation(fields: [cdCidade], references: [id])
  bairro Bairro @relation(fields: [cdBairro], references: [id])

  pacientes                  EnderecoPaciente[]
  profissionais              EnderecoProfissional[]
  enderecoPessoaRelacionadas EnderecoPessoaRelacionada[]

  @@map("enderecos")
}

model EnderecoPaciente {
  id         Int @id @default(autoincrement()) @db.Integer
  cdMaster   Int
  cdPaciente Int
  cdEndereco Int

  paciente Paciente @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente])
  endereco Endereco @relation(fields: [cdEndereco], references: [id])

  @@map("enderecospacientes")
}

model EnderecoProfissional {
  id         Int @id @default(autoincrement()) @db.Integer
  cdProf     Int
  cdEndereco Int

  profissional Profissional @relation(fields: [cdProf], references: [id])
  endereco     Endereco     @relation(fields: [cdEndereco], references: [id])

  @@map("enderecosprofissionais")
}

//-------------------------------------------------------
// MÓDULO 4 — CONTATOS (MVP sem dependências externas)
//-------------------------------------------------------

enum TipoFone {
  R // Residencial
  T // Trabalho
  C // Celular
  P // Principal
}

model Contato {
  id        Int      @id @default(autoincrement()) @db.Integer
  tipo      TipoFone @map("tpTelefone")
  numero    String   @db.VarChar(20)
  stInativo SimNao?  @map("stInativo")

  pacientes     ContatoPaciente[]
  profissionais ContatoProfissional[]

  @@map("contatos")
}

model ContatoPaciente {
  id         Int @id @default(autoincrement()) @db.Integer
  cdMaster   Int
  cdPaciente Int
  cdContato  Int

  paciente Paciente @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente])
  contato  Contato  @relation(fields: [cdContato], references: [id])

  @@map("contatospacientes")
}

model ContatoProfissional {
  id        Int @id @default(autoincrement()) @db.Integer
  cdProf    Int
  cdContato Int

  profissional Profissional @relation(fields: [cdProf], references: [id])
  contato      Contato      @relation(fields: [cdContato], references: [id])

  @@map("contatosprofissionais")
}

//-------------------------------------------------------
// MÓDULO 5 — ATENDIMENTO (MVP sem dependências externas)
//-------------------------------------------------------

model Atendimento {
  id             Int      @id @default(autoincrement()) @db.Integer
  cdMaster       Int
  cdPaciente     Int
  cdProfissional Int      @map("cdProf")
  data           DateTime @db.Timestamptz
  observacao     String?  @db.VarChar(500)

  paciente          Paciente          @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente])
  profissional      Profissional      @relation(fields: [cdProfissional], references: [id])
  evolucaos         Evolucao[]
  sinaisVitais      SinaisVitais[]
  glasgows          Glasgow[]
  afericoesClinicas AfericaoClinica[]
  evaDores          EvaDor[]

  @@map("atendimentos")
}

//-------------------------------------------------------
// MÓDULO 6 — EVOLUÇÃO CLÍNICA (MVP)
//-------------------------------------------------------

model Evolucao {
  id             Int      @id @default(autoincrement()) @db.Integer
  cdAtendimento  Int      @map("cdAtendimento")
  cdProfissional Int      @map("cdProf")
  data           DateTime @db.Timestamptz
  texto          String   @db.VarChar(2000)

  tipoEvolucaoClinicaId Int?              @map("cdTipoEvolucaoClinica")
  humor                 HumorIntensidade?
  alertaRisco           Boolean?          @default(false)
  agravamento           Boolean?          @default(false)
  textoEstruturado      Json?

  atendimento         Atendimento          @relation(fields: [cdAtendimento], references: [id])
  profissional        Profissional         @relation(fields: [cdProfissional], references: [id])
  tipoEvolucaoClinica TipoEvolucaoClinica? @relation(fields: [tipoEvolucaoClinicaId], references: [id])

  cid                EvolucaoCid[]
  dsm                EvolucaoDsm[]
  paciente           Paciente?     @relation(fields: [pacienteCdMaster, pacienteCdPaciente], references: [cdMaster, cdPaciente])
  pacienteCdMaster   Int?
  pacienteCdPaciente Int?

  @@map("evolucoes")
}

enum TipoParentesco {
  P // Pai
  M // Mãe
  T // Tutor
  F // Filho(a)
  C // Cônjuge
  O // Outro
  R // Próprio paciente
}

//-------------------------------------------------------
// MÓDULO 7 — PESSOAS RELACIONADAS (MVP)
//-------------------------------------------------------

model PessoaRelacionada {
  id        Int     @id @default(autoincrement()) @db.Integer
  nome      String  @db.VarChar(120)
  telefone  String? @db.VarChar(20)
  stInativo SimNao? @map("stInativo")

  parentescos ParentescoPaciente[]
  enderecos   EnderecoPessoaRelacionada[]

  @@map("pessoasrelacionadas")
}

model ParentescoPaciente {
  id         Int            @id @default(autoincrement()) @db.Integer
  cdMaster   Int
  cdPaciente Int
  cdPessoa   Int
  parentesco TipoParentesco @map("tipo")

  paciente          Paciente          @relation(fields: [cdMaster, cdPaciente], references: [cdMaster, cdPaciente])
  pessoaRelacionada PessoaRelacionada @relation(fields: [cdPessoa], references: [id])

  @@map("parentescospacientes")
}

//-------------------------------------------------------
// MÓDULO 8 — TABELAS AUXILIARES (MVP)
//-------------------------------------------------------

model Plano {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(120)
  stInativo SimNao? @map("stInativo")

  @@map("planos")
}

model Motivo {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(200)
  stInativo SimNao? @map("stInativo")

  @@map("motivos")
}

model TipoProcedimento {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(120)
  stInativo SimNao? @map("stInativo")

  @@map("tiposprocedimentos")
}

model TipoEvolucaoSimples {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(120)
  stInativo SimNao? @map("stInativo")

  @@map("tiposevolucaosimples")
}

//-------------------------------------------------------
// MÓDULO 9 — LOCALIZAÇÃO COMPLETA (MVP Seguro)
//-------------------------------------------------------

model Pais {
  id            Int     @id @default(autoincrement()) @db.SmallInt
  descricao     String  @db.VarChar(60)
  nacionalidade String? @db.VarChar(60)
  cdIbge        Int?    @db.Integer

  cidades Cidade[]

  @@map("paises")
}

model UnidadeFederacao {
  id        String @id @db.Char(2) // Ex.: 'BA', 'SP'
  descricao String @db.VarChar(60)
  cdIbge    Int?   @db.Integer

  cidades Cidade[]

  @@map("unidadesfederacao")
}

model Cidade {
  id        Int     @id @default(autoincrement()) @db.Integer
  descricao String  @db.VarChar(120)
  cdUf      String  @db.Char(2)
  cdPais    Int
  cepGeral  String? @db.VarChar(9)
  cdIbge    Int?    @db.Integer
  stInativo SimNao? @map("stInativo")

  uf        UnidadeFederacao @relation(fields: [cdUf], references: [id])
  pais      Pais             @relation(fields: [cdPais], references: [id])
  enderecos Endereco[]
  distritos Distrito[]
  bairros   Bairro[]

  @@index([cdUf])
  @@index([cdPais])
  @@map("cidades")
}

//-------------------------------------------------------
// MÓDULO 11 — OCUPAÇÕES E ESCOLARIDADE (MVP)
//-------------------------------------------------------

model Escolaridade {
  id        Int        @id @default(autoincrement()) @db.SmallInt
  descricao String     @db.VarChar(120)
  stInativo SimNao?    @map("stInativo")
  pacientes Paciente[]

  @@map("escolaridades")
}

model Ocupacao {
  id            Int            @id @default(autoincrement()) @db.SmallInt
  descricao     String         @db.VarChar(120)
  cbo           String?        @db.VarChar(10)
  stInativo     SimNao?        @map("stInativo")
  pacientes     Paciente[]
  profissionals Profissional[]

  @@map("ocupacoes")
}

//-------------------------------------------------------
// MÓDULO 13 — LOCALIZAÇÃO AVANÇADA (Bairro, Distrito)
//-------------------------------------------------------

model Distrito {
  id        Int     @id @default(autoincrement()) @db.Integer
  cdCidade  Int
  descricao String  @db.VarChar(120)
  stInativo SimNao? @map("stInativo")

  cidade  Cidade   @relation(fields: [cdCidade], references: [id])
  bairros Bairro[]

  @@map("distritos")
}

model Bairro {
  id         Int     @id @default(autoincrement()) @db.Integer
  cdDistrito Int?
  cdCidade   Int
  descricao  String  @db.VarChar(120)
  stInativo  SimNao? @map("stInativo")

  distrito Distrito? @relation(fields: [cdDistrito], references: [id])
  cidade   Cidade    @relation(fields: [cdCidade], references: [id])

  enderecos Endereco[]

  @@map("bairros")
}

//-------------------------------------------------------
// MÓDULO 14 — ENDEREÇO PARA PESSOA RELACIONADA
//-------------------------------------------------------

model EnderecoPessoaRelacionada {
  id         Int @id @default(autoincrement()) @db.Integer
  cdPessoa   Int
  cdEndereco Int

  pessoaRelacionada PessoaRelacionada @relation(fields: [cdPessoa], references: [id])
  endereco          Endereco          @relation(fields: [cdEndereco], references: [id])

  @@map("enderecospessoasrelacionadas")
}

//-------------------------------------------------------
// MÓDULO 15 — CID, DSM E TIPO DE EVOLUÇÃO CLÍNICA
//-------------------------------------------------------

model Cid {
  id           Int           @id @default(autoincrement()) @db.Integer
  codigo       String        @db.VarChar(10)
  descricao    String        @db.VarChar(300)
  versao       VersaoCid
  stInativo    SimNao?       @map("stInativo")
  evolucaoCids EvolucaoCid[]

  @@unique([codigo, versao])
  @@map("cid")
}

model Dsm {
  id           Int           @id @default(autoincrement()) @db.Integer
  codigo       String        @db.VarChar(10)
  descricao    String        @db.VarChar(300)
  versao       VersaoDsm
  stInativo    SimNao?       @map("stInativo")
  evolucaoDsms EvolucaoDsm[]

  @@unique([codigo, versao])
  @@map("dsm")
}

// Tipos modernos de evolução clínica
model TipoEvolucaoClinica {
  id        Int        @id @default(autoincrement()) @db.Integer
  descricao String     @db.VarChar(120)
  stInativo SimNao?    @map("stInativo")
  evolucaos Evolucao[]

  @@map("tiposevolucoesclinicas")
}

//-------------------------------------------------------
// MÓDULO 16 — RELACIONAMENTO EVOLUCAO ↔ CID / DSM
//-------------------------------------------------------

model EvolucaoCid {
  id         Int @id @default(autoincrement()) @db.Integer
  cdEvolucao Int
  cdCid      Int

  evolucao Evolucao @relation(fields: [cdEvolucao], references: [id])
  cid      Cid      @relation(fields: [cdCid], references: [id])

  @@map("evolucoescid")
}

model EvolucaoDsm {
  id         Int @id @default(autoincrement()) @db.Integer
  cdEvolucao Int
  cdDsm      Int

  evolucao Evolucao @relation(fields: [cdEvolucao], references: [id])
  dsm      Dsm      @relation(fields: [cdDsm], references: [id])

  @@map("evolucoesdsm")
}

model SinaisVitais {
  id            Int      @id @default(autoincrement())
  cdAtendimento Int
  data          DateTime @default(now())

  // Pressão arterial
  paSistolica  Int? @db.SmallInt
  paDiastolica Int? @db.SmallInt

  // Frequências
  fc Int? @db.SmallInt
  fr Int? @db.SmallInt

  // Febre
  temperatura Decimal? @db.Decimal(4, 1)

  // Oxigenação
  spo2 Int? @db.SmallInt

  // Medidas antropométricas
  peso   Decimal? @db.Decimal(5, 2)
  altura Decimal? @db.Decimal(4, 2)
  imc    Decimal? @db.Decimal(5, 2)

  // Dor
  dor         Int?       @db.SmallInt
  escalaDorId Int?
  escalaDor   EscalaDor? @relation(fields: [escalaDorId], references: [id])

  // Posição do paciente
  posicao PosicaoPaciente?

  // Origem da aferição
  origem OrigemAfericao? @default(MANUAL)

  // Informação bruta (logs e integrações)
  metadataRaw Json?

  atendimento Atendimento @relation(fields: [cdAtendimento], references: [id])

  @@map("sinaisvitais")
}

model EscalaDor {
  id        Int     @id @default(autoincrement())
  nome      String  @db.VarChar(100) // Ex: EVA, NIPS, Wong-Baker
  descricao String? @db.VarChar(300)

  sinaisVitais SinaisVitais[]

  @@map("escalasdor")
}

model Glasgow {
  id             Int      @id @default(autoincrement())
  cdAtendimento  Int
  cdProfissional Int?     @map("cdProf")
  data           DateTime @default(now()) @db.Timestamptz

  // Componentes da ECG
  ocular Int // 1–4
  verbal Int // 1–5
  motora Int // 1–6
  total  Int // 3–15, calculado pela API, salvo no banco

  observacao String? @db.VarChar(300)

  // Relacionamentos
  atendimento  Atendimento   @relation(fields: [cdAtendimento], references: [id])
  profissional Profissional? @relation(fields: [cdProfissional], references: [id])

  @@index([cdAtendimento])
  @@index([cdProfissional])
  @@map("glasgow")
}

model AfericaoClinica {
  id             Int      @id @default(autoincrement())
  cdAtendimento  Int
  cdProfissional Int?     @map("cdProf")
  escala         String   @db.VarChar(50) // exemplo: 'GLASGOW', 'EVA', 'BRADEN'
  idRegistro     Int // id da tabela específica (ex.: id da cecom.glasgow)
  data           DateTime @default(now()) @db.Timestamptz

  atendimento  Atendimento   @relation(fields: [cdAtendimento], references: [id])
  profissional Profissional? @relation(fields: [cdProfissional], references: [id])

  @@index([cdAtendimento])
  @@index([escala])
  @@map("afericoesclinicas")
}

model EvaDor {
  id             Int      @id @default(autoincrement())
  cdAtendimento  Int
  cdProfissional Int?
  data           DateTime @default(now()) @db.Timestamptz

  valor      Int // 0 a 10
  observacao String? @db.VarChar(300)

  atendimento  Atendimento   @relation(fields: [cdAtendimento], references: [id])
  profissional Profissional? @relation(fields: [cdProfissional], references: [id])

  @@index([cdAtendimento])
  @@index([cdProfissional])
  @@map("eva")
}

//-------------------------------------------------------
// MÓDULO 17 — Novo módulo/tabelas mínimas para login
//-------------------------------------------------------

enum RoleAuth {
  ADMIN
  PROFISSIONAL
  LEITURA
}

model UsuarioAuth {
  id             Int       @id @default(autoincrement())
  cdMaster       Int       @map("cdMaster")
  email          String    @db.VarChar(120)
  senhaHash      String    @db.VarChar(200)
  role           RoleAuth  @default(LEITURA)
  cdProfissional Int?      @map("cdProfissional")
  stInativo      SimNao?   @map("stInativo")
  dtCadastro     DateTime  @default(now()) @db.Timestamptz
  dtUltLogin     DateTime? @db.Timestamptz

  master       Master        @relation(fields: [cdMaster], references: [id])
  profissional Profissional? @relation(fields: [cdProfissional], references: [id])

  @@unique([cdMaster, email])
  @@index([cdMaster])
  @@map("usuariosauth")
}
